var f=(t=>(t.IDLE="idle",t.START="start",t.PROCESSING="processing",t.FINISHED="finished",t.ERROR="error",t.CANCEL="cancel",t.INIT_SHARED_MEMORY="init_shared_memory",t.INTERMEDIATE="intermediate",t))(f||{}),O=(t=>(t.SPARROW="sparrow",t))(O||{});function F(t,n){return new Promise(e=>{t.addEventListener("message",function r({data:o}){(o==null?void 0:o.type)===n&&(t.removeEventListener("message",r),e(o))})})}F(self,"wasm_bindgen_worker_init").then(async({init:t,receiver:n})=>{const e=await Promise.resolve().then(function(){return V});await e.default(t),postMessage({type:"wasm_bindgen_worker_ready"}),e.wbg_rayon_start_worker(n)});async function D(t,n,e){if(e.numThreads()===0)throw new Error("num_threads must be > 0.");const r={type:"wasm_bindgen_worker_init",init:{module_or_path:t,memory:n},receiver:e.receiver()};await Promise.all(Array.from({length:e.numThreads()},async()=>{const o=new Worker(new URL("/sparroWASM/assets/workerHelpers-ciqjQS7d.js",import.meta.url),{type:"module"});return o.postMessage(r),await F(o,"wasm_bindgen_worker_ready"),o})),e.build()}let s,w=null;function y(){return(w===null||w.buffer!==s.memory.buffer)&&(w=new Uint8Array(s.memory.buffer)),w}let m=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):void 0;m&&m.decode();const j=2146435072;let S=0;function N(t,n){return S+=n,S>=j&&(m=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),m.decode(),S=n),m.decode(y().slice(t,t+n))}function A(t,n){return t=t>>>0,N(t,n)}let p=0;const h=typeof TextEncoder<"u"?new TextEncoder:void 0;h&&(h.encodeInto=function(t,n){const e=h.encode(t);return n.set(e),{read:t.length,written:e.length}});function R(t,n,e){if(e===void 0){const _=h.encode(t),g=n(_.length,1)>>>0;return y().subarray(g,g+_.length).set(_),p=_.length,g}let r=t.length,o=n(r,1)>>>0;const i=y();let a=0;for(;a<r;a++){const _=t.charCodeAt(a);if(_>127)break;i[o+a]=_}if(a!==r){a!==0&&(t=t.slice(a)),o=e(o,r,r=a+t.length*3,1)>>>0;const _=y().subarray(o+a,o+r),g=h.encodeInto(t,_);a+=g.written,o=e(o,r,a,1)>>>0}return p=a,o}let l=null;function u(){return(l===null||l.buffer!==s.memory.buffer)&&(l=new DataView(s.memory.buffer)),l}function c(t){return t==null}function T(t){const n=typeof t;if(n=="number"||n=="boolean"||t==null)return`${t}`;if(n=="string")return`"${t}"`;if(n=="symbol"){const o=t.description;return o==null?"Symbol":`Symbol(${o})`}if(n=="function"){const o=t.name;return typeof o=="string"&&o.length>0?`Function(${o})`:"Function"}if(Array.isArray(t)){const o=t.length;let i="[";o>0&&(i+=T(t[0]));for(let a=1;a<o;a++)i+=", "+T(t[a]);return i+="]",i}const e=/\[object ([^\]]+)\]/.exec(toString.call(t));let r;if(e&&e.length>1)r=e[1];else return toString.call(t);if(r=="Object")try{return"Object("+JSON.stringify(t)+")"}catch{return"Object"}return t instanceof Error?`${t.name}: ${t.message}
${t.stack}`:r}function d(t){const n=s.__externref_table_alloc();return s.__wbindgen_externrefs.set(n,t),n}function M(t,n){try{return t.apply(this,n)}catch(e){const r=d(e);s.__wbindgen_exn_store(r)}}function C(t,n){return t=t>>>0,y().subarray(t/1,t/1+n)}function k(t){const n=s.__wbindgen_externrefs.get(t);return s.__externref_table_dealloc(t),n}function x(t,n){const e=s.init_logger(t,n);if(e[1])throw k(e[0])}function P(t,n,e,r,o,i){const a=s.run_sparrow(t,n,!c(e),c(e)?BigInt(0):e,!c(r),c(r)?BigInt(0):r,o,i);if(a[1])throw k(a[0])}function B(){return s.get_terminate_flag_offset()>>>0}function L(t){return s.initThreadPool(t)}function U(t){s.wbg_rayon_start_worker(t)}const W=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>s.__wbg_wbg_rayon_poolbuilder_free(t>>>0,1));class b{static __wrap(n){n=n>>>0;const e=Object.create(b.prototype);return e.__wbg_ptr=n,W.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const n=this.__wbg_ptr;return this.__wbg_ptr=0,W.unregister(this),n}free(){const n=this.__destroy_into_raw();s.__wbg_wbg_rayon_poolbuilder_free(n,0)}numThreads(){return s.wbg_rayon_poolbuilder_numThreads(this.__wbg_ptr)>>>0}receiver(){return s.wbg_rayon_poolbuilder_receiver(this.__wbg_ptr)>>>0}build(){s.wbg_rayon_poolbuilder_build(this.__wbg_ptr)}}Symbol.dispose&&(b.prototype[Symbol.dispose]=b.prototype.free);const z=new Set(["basic","cors","default"]);async function v(t,n){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,n)}catch(r){if(t.ok&&z.has(t.type)&&t.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const e=await t.arrayBuffer();return await WebAssembly.instantiate(e,n)}else{const e=await WebAssembly.instantiate(t,n);return e instanceof WebAssembly.Instance?{instance:e,module:t}:e}}function $(t){const n={};return n.wbg={},n.wbg.__wbg_Error_e83987f665cf5504=function(e,r){return Error(A(e,r))},n.wbg.__wbg_String_8f0eb39a4a4c2f66=function(e,r){const o=String(r),i=R(o,s.__wbindgen_malloc,s.__wbindgen_realloc),a=p;u().setInt32(e+4,a,!0),u().setInt32(e+0,i,!0)},n.wbg.__wbg___wbindgen_boolean_get_6d5a1ee65bab5f68=function(e){const r=e,o=typeof r=="boolean"?r:void 0;return c(o)?16777215:o?1:0},n.wbg.__wbg___wbindgen_debug_string_df47ffb5e35e6763=function(e,r){const o=T(r),i=R(o,s.__wbindgen_malloc,s.__wbindgen_realloc),a=p;u().setInt32(e+4,a,!0),u().setInt32(e+0,i,!0)},n.wbg.__wbg___wbindgen_is_undefined_2d472862bd29a478=function(e){return e===void 0},n.wbg.__wbg___wbindgen_jsval_loose_eq_b664b38a2f582147=function(e,r){return e==r},n.wbg.__wbg___wbindgen_memory_27faa6e0e73716bd=function(){return s.memory},n.wbg.__wbg___wbindgen_module_66f1f22805762dd9=function(){return E.__wbindgen_wasm_module},n.wbg.__wbg___wbindgen_number_get_a20bf9b85341449d=function(e,r){const o=r,i=typeof o=="number"?o:void 0;u().setFloat64(e+8,c(i)?0:i,!0),u().setInt32(e+0,!c(i),!0)},n.wbg.__wbg___wbindgen_string_get_e4f06c90489ad01b=function(e,r){const o=r,i=typeof o=="string"?o:void 0;var a=c(i)?0:R(i,s.__wbindgen_malloc,s.__wbindgen_realloc),_=p;u().setInt32(e+4,_,!0),u().setInt32(e+0,a,!0)},n.wbg.__wbg___wbindgen_throw_b855445ff6a94295=function(e,r){throw new Error(A(e,r))},n.wbg.__wbg_call_e762c39fa8ea36bf=function(){return M(function(e,r){return e.call(r)},arguments)},n.wbg.__wbg_error_a7f8fbb0523dae15=function(e){console.error(e)},n.wbg.__wbg_getRandomValues_ea728b1d79dae146=function(){return M(function(e){globalThis.crypto.getRandomValues(e)},arguments)},n.wbg.__wbg_instanceof_ArrayBuffer_70beb1189ca63b38=function(e){let r;try{r=e instanceof ArrayBuffer}catch{r=!1}return r},n.wbg.__wbg_instanceof_Uint8Array_20c8e73002f7af98=function(e){let r;try{r=e instanceof Uint8Array}catch{r=!1}return r},n.wbg.__wbg_instanceof_Window_4846dbb3de56c84c=function(e){let r;try{r=e instanceof Window}catch{r=!1}return r},n.wbg.__wbg_length_69bca3cb64fc8748=function(e){return e.length},n.wbg.__wbg_new_1acc0b6eea89d040=function(){return new Object},n.wbg.__wbg_new_5a79be3ab53b8aa5=function(e){return new Uint8Array(e)},n.wbg.__wbg_new_e17d9f43105b08be=function(){return new Array},n.wbg.__wbg_new_no_args_ee98eee5275000a4=function(e,r){return new Function(A(e,r))},n.wbg.__wbg_new_with_length_01aa0dc35aa13543=function(e){return new Uint8Array(e>>>0)},n.wbg.__wbg_now_2c95c9de01293173=function(e){return e.now()},n.wbg.__wbg_performance_7a3ffd0b17f663ad=function(e){return e.performance},n.wbg.__wbg_postMessage_70ada894b0a6df09=function(e){postMessage(e)},n.wbg.__wbg_prototypesetcall_2a6620b6922694b2=function(e,r,o){Uint8Array.prototype.set.call(C(e,r),o)},n.wbg.__wbg_push_df81a39d04db858c=function(e,r){return e.push(r)},n.wbg.__wbg_set_c2abbebe8b9ebee1=function(){return M(function(e,r,o){return Reflect.set(e,r,o)},arguments)},n.wbg.__wbg_startWorkers_2ca11761e08ff5d5=function(e,r,o){return D(e,r,b.__wrap(o))},n.wbg.__wbg_static_accessor_GLOBAL_89e1d9ac6a1b250e=function(){const e=typeof global>"u"?null:global;return c(e)?0:d(e)},n.wbg.__wbg_static_accessor_GLOBAL_THIS_8b530f326a9e48ac=function(){const e=typeof globalThis>"u"?null:globalThis;return c(e)?0:d(e)},n.wbg.__wbg_static_accessor_SELF_6fdf4b64710cc91b=function(){const e=typeof self>"u"?null:self;return c(e)?0:d(e)},n.wbg.__wbg_static_accessor_WINDOW_b45bfc5a37f6cfa2=function(){const e=typeof window>"u"?null:window;return c(e)?0:d(e)},n.wbg.__wbg_subarray_480600f3d6a9f26c=function(e,r,o){return e.subarray(r>>>0,o>>>0)},n.wbg.__wbg_timeOrigin_9f29a08704a944d0=function(e){return e.timeOrigin},n.wbg.__wbindgen_cast_2241b6af4c4b2941=function(e,r){return A(e,r)},n.wbg.__wbindgen_init_externref_table=function(){const e=s.__wbindgen_externrefs,r=e.grow(4);e.set(0,void 0),e.set(r+0,void 0),e.set(r+1,null),e.set(r+2,!0),e.set(r+3,!1)},n.wbg.memory=t||new WebAssembly.Memory({initial:19,maximum:16384,shared:!0}),n}function G(t,n,e){if(s=t.exports,E.__wbindgen_wasm_module=n,l=null,w=null,typeof e<"u"&&(typeof e!="number"||e===0||e%65536!==0))throw"invalid stack size";return s.__wbindgen_start(e),s}async function E(t,n){if(s!==void 0)return s;let e;typeof t<"u"&&(Object.getPrototypeOf(t)===Object.prototype?{module_or_path:t,memory:n,thread_stack_size:e}=t:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof t>"u"&&(t=new URL("/sparroWASM/assets/sparroWASM_bg-DE_vQbIZ.wasm",import.meta.url));const r=$(n);(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:o,module:i}=await v(await t,r);return G(o,i,e)}var V=Object.freeze({__proto__:null,default:E,get_terminate_flag_offset:B,initThreadPool:L,init_logger:x,run_sparrow:P,wbg_rayon_PoolBuilder:b,wbg_rayon_start_worker:U});let I=!1;self.onmessage=async t=>{const{type:n,payload:e}=t.data,r=e.nWorkers;if(!I)try{const o=await E();I=!0;try{await x(5,e.showLogsInstant),self.postMessage({type:f.PROCESSING,message:"Wasm logger successfully initialized"})}catch(_){console.error("Failed to apply WASM logger:",_)}try{await L(r),self.postMessage({type:f.PROCESSING,message:`Wasm thread pool successfully initialized with ${r} threads`})}catch(_){console.error("Failed to initialize WASM thread pool:",_),self.postMessage({type:f.PROCESSING,message:`Failed to initialize WASM thread pool: ${_}`})}const i=o.memory.buffer;if(!(i instanceof SharedArrayBuffer))throw new Error("WASM memory is not a SharedArrayBuffer! Check headers and build flags.");const a=B();self.postMessage({type:f.INIT_SHARED_MEMORY,message:"Worker: Shared memory initialized successfully.",result:{sharedArrayBuffer:i,terminateFlagOffset:a}})}catch(o){self.postMessage({type:f.ERROR,message:"Wasm initialization failed: "+o});return}if(n===f.START){self.postMessage({type:f.PROCESSING,message:"Wasm computation started"});const o=e.input;try{if(e.optimizationAlgo===O.SPARROW){let i;e.timeLimit&&(i=BigInt(e.timeLimit)),P(o,e.showPreviewSvg,i,e.seed,e.useEarlyTermination,e.nWorkers)}}catch(i){self.postMessage({type:f.ERROR,message:"Wasm computation failed: "+i})}}};
