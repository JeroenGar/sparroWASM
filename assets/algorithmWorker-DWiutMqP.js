var f=(e=>(e.IDLE="idle",e.START="start",e.PROCESSING="processing",e.FINISHED="finished",e.ERROR="error",e.CANCEL="cancel",e.INIT_SHARED_MEMORY="init_shared_memory",e.INTERMEDIATE="intermediate",e))(f||{}),O=(e=>(e.SPARROW="sparrow",e))(O||{});function F(e,t){return new Promise(n=>{e.addEventListener("message",function r({data:o}){(o==null?void 0:o.type)===t&&(e.removeEventListener("message",r),n(o))})})}F(self,"wasm_bindgen_worker_init").then(async({init:e,receiver:t})=>{const n=await Promise.resolve().then(function(){return H});await n.default(e),postMessage({type:"wasm_bindgen_worker_ready"}),n.wbg_rayon_start_worker(t)});async function D(e,t,n){if(n.numThreads()===0)throw new Error("num_threads must be > 0.");const r={type:"wasm_bindgen_worker_init",init:{module_or_path:e,memory:t},receiver:n.receiver()};await Promise.all(Array.from({length:n.numThreads()},async()=>{const o=new Worker(new URL("/sparroWASM/assets/workerHelpers-Dn-3TgRX.js",import.meta.url),{type:"module"});return o.postMessage(r),await F(o,"wasm_bindgen_worker_ready"),o})),n.build()}let i,w=null;function y(){return(w===null||w.buffer!==i.memory.buffer)&&(w=new Uint8Array(i.memory.buffer)),w}let h=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});h.decode();const N=2146435072;let E=0;function j(e,t){return E+=t,E>=N&&(h=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),h.decode(),E=t),h.decode(y().slice(e,e+t))}function p(e,t){return e=e>>>0,j(e,t)}let m=0;const A=new TextEncoder;A.encodeInto=function(e,t){const n=A.encode(e);return t.set(n),{read:e.length,written:n.length}};function R(e,t,n){if(n===void 0){const c=A.encode(e),b=t(c.length,1)>>>0;return y().subarray(b,b+c.length).set(c),m=c.length,b}let r=e.length,o=t(r,1)>>>0;const s=y();let a=0;for(;a<r;a++){const c=e.charCodeAt(a);if(c>127)break;s[o+a]=c}if(a!==r){a!==0&&(e=e.slice(a)),o=n(o,r,r=a+e.length*3,1)>>>0;const c=y().subarray(o+a,o+r),b=A.encodeInto(e,c);a+=b.written,o=n(o,r,a,1)>>>0}return m=a,o}let l=null;function u(){return(l===null||l.buffer!==i.memory.buffer)&&(l=new DataView(i.memory.buffer)),l}function d(e){const t=i.__externref_table_alloc();return i.__wbindgen_export_5.set(t,e),t}function M(e,t){try{return e.apply(this,t)}catch(n){const r=d(n);i.__wbindgen_exn_store(r)}}function C(e,t){return e=e>>>0,y().subarray(e/1,e/1+t)}function _(e){return e==null}function T(e){const t=typeof e;if(t=="number"||t=="boolean"||e==null)return`${e}`;if(t=="string")return`"${e}"`;if(t=="symbol"){const o=e.description;return o==null?"Symbol":`Symbol(${o})`}if(t=="function"){const o=e.name;return typeof o=="string"&&o.length>0?`Function(${o})`:"Function"}if(Array.isArray(e)){const o=e.length;let s="[";o>0&&(s+=T(e[0]));for(let a=1;a<o;a++)s+=", "+T(e[a]);return s+="]",s}const n=/\[object ([^\]]+)\]/.exec(toString.call(e));let r;if(n&&n.length>1)r=n[1];else return toString.call(e);if(r=="Object")try{return"Object("+JSON.stringify(e)+")"}catch{return"Object"}return e instanceof Error?`${e.name}: ${e.message}
${e.stack}`:r}function k(e){const t=i.__wbindgen_export_5.get(e);return i.__externref_table_dealloc(e),t}function x(e,t){const n=i.init_logger(e,t);if(n[1])throw k(n[0])}function B(e,t,n,r,o,s){const a=i.run_sparrow(e,t,!_(n),_(n)?BigInt(0):n,!_(r),_(r)?BigInt(0):r,o,s);if(a[1])throw k(a[0])}function P(){return i.get_terminate_flag_offset()>>>0}function L(e){return i.initThreadPool(e)}function U(e){i.wbg_rayon_start_worker(e)}const W=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>i.__wbg_wbg_rayon_poolbuilder_free(e>>>0,1));class g{static __wrap(t){t=t>>>0;const n=Object.create(g.prototype);return n.__wbg_ptr=t,W.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,W.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_wbg_rayon_poolbuilder_free(t,0)}numThreads(){return i.wbg_rayon_poolbuilder_numThreads(this.__wbg_ptr)>>>0}receiver(){return i.wbg_rayon_poolbuilder_receiver(this.__wbg_ptr)>>>0}build(){i.wbg_rayon_poolbuilder_build(this.__wbg_ptr)}}Symbol.dispose&&(g.prototype[Symbol.dispose]=g.prototype.free);const z=new Set(["basic","cors","default"]);async function $(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(r){if(e.ok&&z.has(e.type)&&e.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function v(){const e={};return e.wbg={},e.wbg.__wbg_Error_e17e777aac105295=function(t,n){return Error(p(t,n))},e.wbg.__wbg_String_8f0eb39a4a4c2f66=function(t,n){const r=String(n),o=R(r,i.__wbindgen_malloc,i.__wbindgen_realloc),s=m;u().setInt32(t+4,s,!0),u().setInt32(t+0,o,!0)},e.wbg.__wbg_call_13410aac570ffff7=function(){return M(function(t,n){return t.call(n)},arguments)},e.wbg.__wbg_error_99981e16d476aa5c=function(t){console.error(t)},e.wbg.__wbg_getRandomValues_ea728b1d79dae146=function(){return M(function(t){globalThis.crypto.getRandomValues(t)},arguments)},e.wbg.__wbg_instanceof_ArrayBuffer_67f3012529f6a2dd=function(t){let n;try{n=t instanceof ArrayBuffer}catch{n=!1}return n},e.wbg.__wbg_instanceof_Uint8Array_9a8378d955933db7=function(t){let n;try{n=t instanceof Uint8Array}catch{n=!1}return n},e.wbg.__wbg_instanceof_Window_12d20d558ef92592=function(t){let n;try{n=t instanceof Window}catch{n=!1}return n},e.wbg.__wbg_length_6bb7e81f9d7713e4=function(t){return t.length},e.wbg.__wbg_new_19c25a3f2fa63a02=function(){return new Object},e.wbg.__wbg_new_1f3a344cf3123716=function(){return new Array},e.wbg.__wbg_new_638ebfaedbf32a5e=function(t){return new Uint8Array(t)},e.wbg.__wbg_newnoargs_254190557c45b4ec=function(t,n){return new Function(p(t,n))},e.wbg.__wbg_newwithlength_a167dcc7aaa3ba77=function(t){return new Uint8Array(t>>>0)},e.wbg.__wbg_now_2c95c9de01293173=function(t){return t.now()},e.wbg.__wbg_performance_7a3ffd0b17f663ad=function(t){return t.performance},e.wbg.__wbg_postMessage_70ada894b0a6df09=function(t){postMessage(t)},e.wbg.__wbg_prototypesetcall_3d4a26c1ed734349=function(t,n,r){Uint8Array.prototype.set.call(C(t,n),r)},e.wbg.__wbg_push_330b2eb93e4e1212=function(t,n){return t.push(n)},e.wbg.__wbg_set_453345bcda80b89a=function(){return M(function(t,n,r){return Reflect.set(t,n,r)},arguments)},e.wbg.__wbg_startWorkers_2ca11761e08ff5d5=function(t,n,r){return D(t,n,g.__wrap(r))},e.wbg.__wbg_static_accessor_GLOBAL_8921f820c2ce3f12=function(){const t=typeof global>"u"?null:global;return _(t)?0:d(t)},e.wbg.__wbg_static_accessor_GLOBAL_THIS_f0a4409105898184=function(){const t=typeof globalThis>"u"?null:globalThis;return _(t)?0:d(t)},e.wbg.__wbg_static_accessor_SELF_995b214ae681ff99=function(){const t=typeof self>"u"?null:self;return _(t)?0:d(t)},e.wbg.__wbg_static_accessor_WINDOW_cde3890479c675ea=function(){const t=typeof window>"u"?null:window;return _(t)?0:d(t)},e.wbg.__wbg_subarray_70fd07feefe14294=function(t,n,r){return t.subarray(n>>>0,r>>>0)},e.wbg.__wbg_timeOrigin_9f29a08704a944d0=function(t){return t.timeOrigin},e.wbg.__wbg_wbindgenbooleanget_3fe6f642c7d97746=function(t){const n=t,r=typeof n=="boolean"?n:void 0;return _(r)?16777215:r?1:0},e.wbg.__wbg_wbindgendebugstring_99ef257a3ddda34d=function(t,n){const r=T(n),o=R(r,i.__wbindgen_malloc,i.__wbindgen_realloc),s=m;u().setInt32(t+4,s,!0),u().setInt32(t+0,o,!0)},e.wbg.__wbg_wbindgenisundefined_c4b71d073b92f3c5=function(t){return t===void 0},e.wbg.__wbg_wbindgenjsvallooseeq_9bec8c9be826bed1=function(t,n){return t==n},e.wbg.__wbg_wbindgenmemory_d84da70f7c42d172=function(){return i.memory},e.wbg.__wbg_wbindgenmodule_7e59019f6366ff9c=function(){return S.__wbindgen_wasm_module},e.wbg.__wbg_wbindgennumberget_f74b4c7525ac05cb=function(t,n){const r=n,o=typeof r=="number"?r:void 0;u().setFloat64(t+8,_(o)?0:o,!0),u().setInt32(t+0,!_(o),!0)},e.wbg.__wbg_wbindgenstringget_0f16a6ddddef376f=function(t,n){const r=n,o=typeof r=="string"?r:void 0;var s=_(o)?0:R(o,i.__wbindgen_malloc,i.__wbindgen_realloc),a=m;u().setInt32(t+4,a,!0),u().setInt32(t+0,s,!0)},e.wbg.__wbg_wbindgenthrow_451ec1a8469d7eb6=function(t,n){throw new Error(p(t,n))},e.wbg.__wbindgen_cast_2241b6af4c4b2941=function(t,n){return p(t,n)},e.wbg.__wbindgen_init_externref_table=function(){const t=i.__wbindgen_export_5,n=t.grow(4);t.set(0,void 0),t.set(n+0,void 0),t.set(n+1,null),t.set(n+2,!0),t.set(n+3,!1)},e}function G(e,t){e.wbg.memory=t||new WebAssembly.Memory({initial:19,maximum:16384,shared:!0})}function V(e,t,n){if(i=e.exports,S.__wbindgen_wasm_module=t,l=null,w=null,typeof n<"u"&&(typeof n!="number"||n===0||n%65536!==0))throw"invalid stack size";return i.__wbindgen_start(n),i}async function S(e,t){if(i!==void 0)return i;let n;typeof e<"u"&&(Object.getPrototypeOf(e)===Object.prototype?{module_or_path:e,memory:t,thread_stack_size:n}=e:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof e>"u"&&(e=new URL("/sparroWASM/assets/sparroWASM_bg-B0iX1u1X.wasm",import.meta.url));const r=v();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e)),G(r,t);const{instance:o,module:s}=await $(await e,r);return V(o,s,n)}var H=Object.freeze({__proto__:null,default:S,get_terminate_flag_offset:P,initThreadPool:L,init_logger:x,run_sparrow:B,wbg_rayon_PoolBuilder:g,wbg_rayon_start_worker:U});let I=!1;self.onmessage=async e=>{const{type:t,payload:n}=e.data,r=n.nWorkers;if(!I)try{const o=await S();I=!0;try{await x(5,n.showLogsInstant),self.postMessage({type:f.PROCESSING,message:"Wasm logger successfully initialized"})}catch(c){console.error("Failed to apply WASM logger:",c)}try{await L(r),self.postMessage({type:f.PROCESSING,message:`Wasm thread pool successfully initialized with ${r} threads`})}catch(c){console.error("Failed to initialize WASM thread pool:",c),self.postMessage({type:f.PROCESSING,message:`Failed to initialize WASM thread pool: ${c}`})}const s=o.memory.buffer;if(!(s instanceof SharedArrayBuffer))throw new Error("WASM memory is not a SharedArrayBuffer! Check headers and build flags.");const a=P();self.postMessage({type:f.INIT_SHARED_MEMORY,message:"Worker: Shared memory initialized successfully.",result:{sharedArrayBuffer:s,terminateFlagOffset:a}})}catch(o){self.postMessage({type:f.ERROR,message:"Wasm initialization failed: "+o});return}if(t===f.START){self.postMessage({type:f.PROCESSING,message:"Wasm computation started"});const o=n.input;try{if(n.optimizationAlgo===O.SPARROW){let s;n.timeLimit&&(s=BigInt(n.timeLimit)),B(o,n.showPreviewSvg,s,n.seed,n.useEarlyTermination,n.nWorkers)}}catch(s){self.postMessage({type:f.ERROR,message:"Wasm computation failed: "+s})}}};
