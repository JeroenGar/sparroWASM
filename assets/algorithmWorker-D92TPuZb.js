var f=(t=>(t.IDLE="idle",t.START="start",t.PROCESSING="processing",t.FINISHED="finished",t.ERROR="error",t.CANCEL="cancel",t.INIT_SHARED_MEMORY="init_shared_memory",t.INTERMEDIATE="intermediate",t))(f||{}),W=(t=>(t.SPARROW="sparrow",t))(W||{});function T(t,e){return new Promise(n=>{t.addEventListener("message",function r({data:o}){(o==null?void 0:o.type)===e&&(t.removeEventListener("message",r),n(o))})})}T(self,"wasm_bindgen_worker_init").then(async({init:t,receiver:e})=>{const n=await Promise.resolve().then(function(){return H});await n.default(t),postMessage({type:"wasm_bindgen_worker_ready"}),n.wbg_rayon_start_worker(e)});async function N(t,e,n){if(n.numThreads()===0)throw new Error("num_threads must be > 0.");const r={type:"wasm_bindgen_worker_init",init:{module_or_path:t,memory:e},receiver:n.receiver()};await Promise.all(Array.from({length:n.numThreads()},async()=>{const o=new Worker(new URL("/sparroWASM/assets/workerHelpers-DkQkRMT-.js",import.meta.url),{type:"module"});return o.postMessage(r),await T(o,"wasm_bindgen_worker_ready"),o})),n.build()}function k(){return s.get_terminate_flag_offset()>>>0}function F(t){return s.initThreadPool(t)}function B(t,e){const n=s.init_logger(t,e);if(n[1])throw L(n[0])}function x(t,e,n,r,o,i){const a=s.run_sparrow(t,e,!_(n),_(n)?BigInt(0):n,!_(r),_(r)?BigInt(0):r,o,i);if(a[1])throw L(a[0])}class b{static __wrap(e){e=e>>>0;const n=Object.create(b.prototype);return n.__wbg_ptr=e,O.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,O.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_wbg_rayon_poolbuilder_free(e,0)}build(){s.wbg_rayon_poolbuilder_build(this.__wbg_ptr)}numThreads(){return s.wbg_rayon_poolbuilder_numThreads(this.__wbg_ptr)>>>0}receiver(){return s.wbg_rayon_poolbuilder_receiver(this.__wbg_ptr)>>>0}}Symbol.dispose&&(b.prototype[Symbol.dispose]=b.prototype.free);function z(t){s.wbg_rayon_start_worker(t)}function P(){return{__proto__:null,"./sparroWASM_bg.js":{__proto__:null,__wbg_Error_8c4e43fe74559d73:function(e,n){return Error(h(e,n))},__wbg_String_8f0eb39a4a4c2f66:function(e,n){const r=String(n),o=M(r,s.__wbindgen_malloc,s.__wbindgen_realloc),i=m;u().setInt32(e+4,i,!0),u().setInt32(e+0,o,!0)},__wbg___wbindgen_boolean_get_bbbb1c18aa2f5e25:function(e){const n=e,r=typeof n=="boolean"?n:void 0;return _(r)?16777215:r?1:0},__wbg___wbindgen_debug_string_0bc8482c6e3508ae:function(e,n){const r=E(n),o=M(r,s.__wbindgen_malloc,s.__wbindgen_realloc),i=m;u().setInt32(e+4,i,!0),u().setInt32(e+0,o,!0)},__wbg___wbindgen_is_undefined_9e4d92534c42d778:function(e){return e===void 0},__wbg___wbindgen_jsval_loose_eq_9dd77d8cd6671811:function(e,n){return e==n},__wbg___wbindgen_memory_bd1fbcf21fbef3c8:function(){return s.memory},__wbg___wbindgen_module_f6b8052d79c1cc16:function(){return j},__wbg___wbindgen_number_get_8ff4255516ccad3e:function(e,n){const r=n,o=typeof r=="number"?r:void 0;u().setFloat64(e+8,_(o)?0:o,!0),u().setInt32(e+0,!_(o),!0)},__wbg___wbindgen_string_get_72fb696202c56729:function(e,n){const r=n,o=typeof r=="string"?r:void 0;var i=_(o)?0:M(o,s.__wbindgen_malloc,s.__wbindgen_realloc),a=m;u().setInt32(e+4,a,!0),u().setInt32(e+0,i,!0)},__wbg___wbindgen_throw_be289d5034ed271b:function(e,n){throw new Error(h(e,n))},__wbg_call_389efe28435a9388:function(){return S(function(e,n){return e.call(n)},arguments)},__wbg_error_9a7fe3f932034cde:function(e){console.error(e)},__wbg_getRandomValues_04db461bb4ff2e00:function(){return S(function(e){globalThis.crypto.getRandomValues(e)},arguments)},__wbg_instanceof_ArrayBuffer_c367199e2fa2aa04:function(e){let n;try{n=e instanceof ArrayBuffer}catch{n=!1}return n},__wbg_instanceof_Uint8Array_9b9075935c74707c:function(e){let n;try{n=e instanceof Uint8Array}catch{n=!1}return n},__wbg_instanceof_Window_ed49b2db8df90359:function(e){let n;try{n=e instanceof Window}catch{n=!1}return n},__wbg_length_32ed9a279acd054c:function(e){return e.length},__wbg_new_361308b2356cecd0:function(){return new Object},__wbg_new_3eb36ae241fe6f44:function(){return new Array},__wbg_new_dd2b680c8bf6ae29:function(e){return new Uint8Array(e)},__wbg_new_no_args_1c7c842f08d00ebb:function(e,n){return new Function(h(e,n))},__wbg_new_with_length_a2c39cbe88fd8ff1:function(e){return new Uint8Array(e>>>0)},__wbg_now_2c95c9de01293173:function(e){return e.now()},__wbg_performance_7a3ffd0b17f663ad:function(e){return e.performance},__wbg_postMessage_70ada894b0a6df09:function(e){postMessage(e)},__wbg_prototypesetcall_bdcdcc5842e4d77d:function(e,n,r){Uint8Array.prototype.set.call(U(e,n),r)},__wbg_push_8ffdcb2063340ba5:function(e,n){return e.push(n)},__wbg_set_6cb8631f80447a67:function(){return S(function(e,n,r){return Reflect.set(e,n,r)},arguments)},__wbg_startWorkers_2ca11761e08ff5d5:function(e,n,r){return N(e,n,b.__wrap(r))},__wbg_static_accessor_GLOBAL_12837167ad935116:function(){const e=typeof global>"u"?null:global;return _(e)?0:d(e)},__wbg_static_accessor_GLOBAL_THIS_e628e89ab3b1c95f:function(){const e=typeof globalThis>"u"?null:globalThis;return _(e)?0:d(e)},__wbg_static_accessor_SELF_a621d3dfbb60d0ce:function(){const e=typeof self>"u"?null:self;return _(e)?0:d(e)},__wbg_static_accessor_WINDOW_f8727f0cf888e0bd:function(){const e=typeof window>"u"?null:window;return _(e)?0:d(e)},__wbg_subarray_a96e1fef17ed23cb:function(e,n,r){return e.subarray(n>>>0,r>>>0)},__wbg_timeOrigin_9f29a08704a944d0:function(e){return e.timeOrigin},__wbindgen_cast_0000000000000001:function(e,n){return h(e,n)},__wbindgen_init_externref_table:function(){const e=s.__wbindgen_externrefs,n=e.grow(4);e.set(0,void 0),e.set(n+0,void 0),e.set(n+1,null),e.set(n+2,!0),e.set(n+3,!1)}}}}const O=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>s.__wbg_wbg_rayon_poolbuilder_free(t>>>0,1));function d(t){const e=s.__externref_table_alloc();return s.__wbindgen_externrefs.set(e,t),e}function E(t){const e=typeof t;if(e=="number"||e=="boolean"||t==null)return`${t}`;if(e=="string")return`"${t}"`;if(e=="symbol"){const o=t.description;return o==null?"Symbol":`Symbol(${o})`}if(e=="function"){const o=t.name;return typeof o=="string"&&o.length>0?`Function(${o})`:"Function"}if(Array.isArray(t)){const o=t.length;let i="[";o>0&&(i+=E(t[0]));for(let a=1;a<o;a++)i+=", "+E(t[a]);return i+="]",i}const n=/\[object ([^\]]+)\]/.exec(toString.call(t));let r;if(n&&n.length>1)r=n[1];else return toString.call(t);if(r=="Object")try{return"Object("+JSON.stringify(t)+")"}catch{return"Object"}return t instanceof Error?`${t.name}: ${t.message}
${t.stack}`:r}function U(t,e){return t=t>>>0,y().subarray(t/1,t/1+e)}let l=null;function u(){return(l===null||l.buffer.detached===!0||l.buffer.detached===void 0&&l.buffer!==s.memory.buffer)&&(l=new DataView(s.memory.buffer)),l}function h(t,e){return t=t>>>0,G(t,e)}let w=null;function y(){return(w===null||w.byteLength===0)&&(w=new Uint8Array(s.memory.buffer)),w}function S(t,e){try{return t.apply(this,e)}catch(n){const r=d(n);s.__wbindgen_exn_store(r)}}function _(t){return t==null}function M(t,e,n){if(n===void 0){const c=p.encode(t),g=e(c.length,1)>>>0;return y().subarray(g,g+c.length).set(c),m=c.length,g}let r=t.length,o=e(r,1)>>>0;const i=y();let a=0;for(;a<r;a++){const c=t.charCodeAt(a);if(c>127)break;i[o+a]=c}if(a!==r){a!==0&&(t=t.slice(a)),o=n(o,r,r=a+t.length*3,1)>>>0;const c=y().subarray(o+a,o+r),g=p.encodeInto(t,c);a+=g.written,o=n(o,r,a,1)>>>0}return m=a,o}function L(t){const e=s.__wbindgen_externrefs.get(t);return s.__externref_table_dealloc(t),e}let A=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});A.decode();const v=2146435072;let R=0;function G(t,e){return R+=e,R>=v&&(A=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),A.decode(),R=e),A.decode(y().subarray(t,t+e))}const p=new TextEncoder;"encodeInto"in p||(p.encodeInto=function(t,e){const n=p.encode(t);return e.set(n),{read:t.length,written:n.length}});let m=0,j,s;function C(t,e){return s=t.exports,j=e,l=null,w=null,s.__wbindgen_start(),s}async function $(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(o){if(t.ok&&n(t.type)&&t.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const r=await t.arrayBuffer();return await WebAssembly.instantiate(r,e)}else{const r=await WebAssembly.instantiate(t,e);return r instanceof WebAssembly.Instance?{instance:r,module:t}:r}function n(r){switch(r){case"basic":case"cors":case"default":return!0}return!1}}function V(t){if(s!==void 0)return s;t!==void 0&&(Object.getPrototypeOf(t)===Object.prototype?{module:t}=t:console.warn("using deprecated parameters for `initSync()`; pass a single object instead"));const e=P();t instanceof WebAssembly.Module||(t=new WebAssembly.Module(t));const n=new WebAssembly.Instance(t,e);return C(n,t)}async function D(t){if(s!==void 0)return s;t!==void 0&&(Object.getPrototypeOf(t)===Object.prototype?{module_or_path:t}=t:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),t===void 0&&(t=new URL("/sparroWASM/assets/sparroWASM_bg-cU85OGpg.wasm",import.meta.url));const e=P();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:n,module:r}=await $(await t,e);return C(n,r)}var H=Object.freeze({__proto__:null,default:D,get_terminate_flag_offset:k,initSync:V,initThreadPool:F,init_logger:B,run_sparrow:x,wbg_rayon_PoolBuilder:b,wbg_rayon_start_worker:z});let I=!1;self.onmessage=async t=>{const{type:e,payload:n}=t.data,r=n.nWorkers;if(!I)try{if(typeof crossOriginIsolated>"u"||!crossOriginIsolated)throw new Error("Cross-origin isolation not enabled. SharedArrayBuffer is not available. COOP/COEP headers may not be properly set by the service worker. This is common on Android - try refreshing the page.");if(typeof SharedArrayBuffer>"u")throw new Error("SharedArrayBuffer is not available in this browser/context. Multithreading features will not work.");self.postMessage({type:f.PROCESSING,message:"Cross-origin isolation verified. Initializing WASM..."});const o=await D();I=!0;try{await B(5,n.showLogsInstant),self.postMessage({type:f.PROCESSING,message:"Wasm logger successfully initialized"})}catch(c){console.error("Failed to apply WASM logger:",c)}try{await F(r),self.postMessage({type:f.PROCESSING,message:`Wasm thread pool successfully initialized with ${r} threads`})}catch(c){console.error("Failed to initialize WASM thread pool:",c),self.postMessage({type:f.PROCESSING,message:`Failed to initialize WASM thread pool: ${c}`})}const i=o.memory.buffer;if(!(i instanceof SharedArrayBuffer))throw new Error("WASM memory is not a SharedArrayBuffer! Check headers and build flags.");const a=k();self.postMessage({type:f.INIT_SHARED_MEMORY,message:"Worker: Shared memory initialized successfully.",result:{sharedArrayBuffer:i,terminateFlagOffset:a}})}catch(o){self.postMessage({type:f.ERROR,message:"Wasm initialization failed: "+o});return}if(e===f.START){self.postMessage({type:f.PROCESSING,message:"Wasm computation started"});const o=n.input;try{if(n.optimizationAlgo===W.SPARROW){let i;n.timeLimit&&(i=BigInt(n.timeLimit)),x(o,n.showPreviewSvg,i,n.seed,n.useEarlyTermination,n.nWorkers)}}catch(i){self.postMessage({type:f.ERROR,message:"Wasm computation failed: "+i})}}};
