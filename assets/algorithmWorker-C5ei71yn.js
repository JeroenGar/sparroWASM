var f=(t=>(t.IDLE="idle",t.START="start",t.PROCESSING="processing",t.FINISHED="finished",t.ERROR="error",t.CANCEL="cancel",t.INIT_SHARED_MEMORY="init_shared_memory",t.INTERMEDIATE="intermediate",t))(f||{}),W=(t=>(t.SPARROW="sparrow",t))(W||{});function F(t,n){return new Promise(e=>{t.addEventListener("message",function r({data:o}){(o==null?void 0:o.type)===n&&(t.removeEventListener("message",r),e(o))})})}F(self,"wasm_bindgen_worker_init").then(async({init:t,receiver:n})=>{const e=await Promise.resolve().then(function(){return V});await e.default(t),postMessage({type:"wasm_bindgen_worker_ready"}),e.wbg_rayon_start_worker(n)});async function C(t,n,e){if(e.numThreads()===0)throw new Error("num_threads must be > 0.");const r={type:"wasm_bindgen_worker_init",init:{module_or_path:t,memory:n},receiver:e.receiver()};await Promise.all(Array.from({length:e.numThreads()},async()=>{const o=new Worker(new URL("/sparroWASM/assets/workerHelpers-DD_Oc4FB.js",import.meta.url),{type:"module"});return o.postMessage(r),await F(o,"wasm_bindgen_worker_ready"),o})),e.build()}let s;function w(t){const n=s.__externref_table_alloc();return s.__wbindgen_externrefs.set(n,t),n}function I(t){const n=typeof t;if(n=="number"||n=="boolean"||t==null)return`${t}`;if(n=="string")return`"${t}"`;if(n=="symbol"){const o=t.description;return o==null?"Symbol":`Symbol(${o})`}if(n=="function"){const o=t.name;return typeof o=="string"&&o.length>0?`Function(${o})`:"Function"}if(Array.isArray(t)){const o=t.length;let i="[";o>0&&(i+=I(t[0]));for(let a=1;a<o;a++)i+=", "+I(t[a]);return i+="]",i}const e=/\[object ([^\]]+)\]/.exec(toString.call(t));let r;if(e&&e.length>1)r=e[1];else return toString.call(t);if(r=="Object")try{return"Object("+JSON.stringify(t)+")"}catch{return"Object"}return t instanceof Error?`${t.name}: ${t.message}
${t.stack}`:r}function L(t,n){return t=t>>>0,y().subarray(t/1,t/1+n)}let l=null;function u(){return(l===null||l.buffer!==s.memory.buffer)&&(l=new DataView(s.memory.buffer)),l}function A(t,n){return t=t>>>0,j(t,n)}let d=null;function y(){return(d===null||d.buffer!==s.memory.buffer)&&(d=new Uint8Array(s.memory.buffer)),d}function E(t,n){try{return t.apply(this,n)}catch(e){const r=w(e);s.__wbindgen_exn_store(r)}}function c(t){return t==null}function R(t,n,e){if(e===void 0){const _=p.encode(t),b=n(_.length,1)>>>0;return y().subarray(b,b+_.length).set(_),h=_.length,b}let r=t.length,o=n(r,1)>>>0;const i=y();let a=0;for(;a<r;a++){const _=t.charCodeAt(a);if(_>127)break;i[o+a]=_}if(a!==r){a!==0&&(t=t.slice(a)),o=e(o,r,r=a+t.length*3,1)>>>0;const _=y().subarray(o+a,o+r),b=p.encodeInto(t,_);a+=b.written,o=e(o,r,a,1)>>>0}return h=a,o}function k(t){const n=s.__wbindgen_externrefs.get(t);return s.__externref_table_dealloc(t),n}let m=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):void 0;m&&m.decode();const N=2146435072;let M=0;function j(t,n){return M+=n,M>=N&&(m=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),m.decode(),M=n),m.decode(y().slice(t,t+n))}const p=typeof TextEncoder<"u"?new TextEncoder:void 0;p&&(p.encodeInto=function(t,n){const e=p.encode(t);return n.set(e),{read:t.length,written:e.length}});let h=0;const O=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>s.__wbg_wbg_rayon_poolbuilder_free(t>>>0,1));function P(){return s.get_terminate_flag_offset()>>>0}function x(t){return s.initThreadPool(t)}function B(t,n){const e=s.init_logger(t,n);if(e[1])throw k(e[0])}function D(t,n,e,r,o,i){const a=s.run_sparrow(t,n,!c(e),c(e)?BigInt(0):e,!c(r),c(r)?BigInt(0):r,o,i);if(a[1])throw k(a[0])}class g{static __wrap(n){n=n>>>0;const e=Object.create(g.prototype);return e.__wbg_ptr=n,O.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const n=this.__wbg_ptr;return this.__wbg_ptr=0,O.unregister(this),n}free(){const n=this.__destroy_into_raw();s.__wbg_wbg_rayon_poolbuilder_free(n,0)}numThreads(){return s.wbg_rayon_poolbuilder_numThreads(this.__wbg_ptr)>>>0}receiver(){return s.wbg_rayon_poolbuilder_receiver(this.__wbg_ptr)>>>0}build(){s.wbg_rayon_poolbuilder_build(this.__wbg_ptr)}}Symbol.dispose&&(g.prototype[Symbol.dispose]=g.prototype.free);function v(t){s.wbg_rayon_start_worker(t)}const z=new Set(["basic","cors","default"]);async function U(t,n){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,n)}catch(r){if(t.ok&&z.has(t.type)&&t.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const e=await t.arrayBuffer();return await WebAssembly.instantiate(e,n)}else{const e=await WebAssembly.instantiate(t,n);return e instanceof WebAssembly.Instance?{instance:e,module:t}:e}}function $(t){const n={};return n.wbg={},n.wbg.__wbg_Error_52673b7de5a0ca89=function(e,r){return Error(A(e,r))},n.wbg.__wbg_String_8f0eb39a4a4c2f66=function(e,r){const o=String(r),i=R(o,s.__wbindgen_malloc,s.__wbindgen_realloc),a=h;u().setInt32(e+4,a,!0),u().setInt32(e+0,i,!0)},n.wbg.__wbg___wbindgen_boolean_get_dea25b33882b895b=function(e){const r=e,o=typeof r=="boolean"?r:void 0;return c(o)?16777215:o?1:0},n.wbg.__wbg___wbindgen_debug_string_adfb662ae34724b6=function(e,r){const o=I(r),i=R(o,s.__wbindgen_malloc,s.__wbindgen_realloc),a=h;u().setInt32(e+4,a,!0),u().setInt32(e+0,i,!0)},n.wbg.__wbg___wbindgen_is_undefined_f6b95eab589e0269=function(e){return e===void 0},n.wbg.__wbg___wbindgen_jsval_loose_eq_766057600fdd1b0d=function(e,r){return e==r},n.wbg.__wbg___wbindgen_memory_a342e963fbcabd68=function(){return s.memory},n.wbg.__wbg___wbindgen_module_967adef62ea6cbf8=function(){return S.__wbindgen_wasm_module},n.wbg.__wbg___wbindgen_number_get_9619185a74197f95=function(e,r){const o=r,i=typeof o=="number"?o:void 0;u().setFloat64(e+8,c(i)?0:i,!0),u().setInt32(e+0,!c(i),!0)},n.wbg.__wbg___wbindgen_string_get_a2a31e16edf96e42=function(e,r){const o=r,i=typeof o=="string"?o:void 0;var a=c(i)?0:R(i,s.__wbindgen_malloc,s.__wbindgen_realloc),_=h;u().setInt32(e+4,_,!0),u().setInt32(e+0,a,!0)},n.wbg.__wbg___wbindgen_throw_dd24417ed36fc46e=function(e,r){throw new Error(A(e,r))},n.wbg.__wbg_call_abb4ff46ce38be40=function(){return E(function(e,r){return e.call(r)},arguments)},n.wbg.__wbg_error_7bc7d576a6aaf855=function(e){console.error(e)},n.wbg.__wbg_getRandomValues_ea728b1d79dae146=function(){return E(function(e){globalThis.crypto.getRandomValues(e)},arguments)},n.wbg.__wbg_instanceof_ArrayBuffer_f3320d2419cd0355=function(e){let r;try{r=e instanceof ArrayBuffer}catch{r=!1}return r},n.wbg.__wbg_instanceof_Uint8Array_da54ccc9d3e09434=function(e){let r;try{r=e instanceof Uint8Array}catch{r=!1}return r},n.wbg.__wbg_instanceof_Window_b5cf7783caa68180=function(e){let r;try{r=e instanceof Window}catch{r=!1}return r},n.wbg.__wbg_length_22ac23eaec9d8053=function(e){return e.length},n.wbg.__wbg_new_1ba21ce319a06297=function(){return new Object},n.wbg.__wbg_new_25f239778d6112b9=function(){return new Array},n.wbg.__wbg_new_6421f6084cc5bc5a=function(e){return new Uint8Array(e)},n.wbg.__wbg_new_no_args_cb138f77cf6151ee=function(e,r){return new Function(A(e,r))},n.wbg.__wbg_new_with_length_aa5eaf41d35235e5=function(e){return new Uint8Array(e>>>0)},n.wbg.__wbg_now_2c95c9de01293173=function(e){return e.now()},n.wbg.__wbg_performance_7a3ffd0b17f663ad=function(e){return e.performance},n.wbg.__wbg_postMessage_70ada894b0a6df09=function(e){postMessage(e)},n.wbg.__wbg_prototypesetcall_dfe9b766cdc1f1fd=function(e,r,o){Uint8Array.prototype.set.call(L(e,r),o)},n.wbg.__wbg_push_7d9be8f38fc13975=function(e,r){return e.push(r)},n.wbg.__wbg_set_781438a03c0c3c81=function(){return E(function(e,r,o){return Reflect.set(e,r,o)},arguments)},n.wbg.__wbg_startWorkers_2ca11761e08ff5d5=function(e,r,o){return C(e,r,g.__wrap(o))},n.wbg.__wbg_static_accessor_GLOBAL_769e6b65d6557335=function(){const e=typeof global>"u"?null:global;return c(e)?0:w(e)},n.wbg.__wbg_static_accessor_GLOBAL_THIS_60cf02db4de8e1c1=function(){const e=typeof globalThis>"u"?null:globalThis;return c(e)?0:w(e)},n.wbg.__wbg_static_accessor_SELF_08f5a74c69739274=function(){const e=typeof self>"u"?null:self;return c(e)?0:w(e)},n.wbg.__wbg_static_accessor_WINDOW_a8924b26aa92d024=function(){const e=typeof window>"u"?null:window;return c(e)?0:w(e)},n.wbg.__wbg_subarray_845f2f5bce7d061a=function(e,r,o){return e.subarray(r>>>0,o>>>0)},n.wbg.__wbg_timeOrigin_9f29a08704a944d0=function(e){return e.timeOrigin},n.wbg.__wbindgen_cast_2241b6af4c4b2941=function(e,r){return A(e,r)},n.wbg.__wbindgen_init_externref_table=function(){const e=s.__wbindgen_externrefs,r=e.grow(4);e.set(0,void 0),e.set(r+0,void 0),e.set(r+1,null),e.set(r+2,!0),e.set(r+3,!1)},n.wbg.memory=t||new WebAssembly.Memory({initial:19,maximum:16384,shared:!0}),n}function G(t,n,e){if(s=t.exports,S.__wbindgen_wasm_module=n,l=null,d=null,typeof e<"u"&&(typeof e!="number"||e===0||e%65536!==0))throw"invalid stack size";return s.__wbindgen_start(e),s}async function S(t,n){if(s!==void 0)return s;let e;typeof t<"u"&&(Object.getPrototypeOf(t)===Object.prototype?{module_or_path:t,memory:n,thread_stack_size:e}=t:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof t>"u"&&(t=new URL("/sparroWASM/assets/sparroWASM_bg-C3jDIvPT.wasm",import.meta.url));const r=$(n);(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:o,module:i}=await U(await t,r);return G(o,i,e)}var V=Object.freeze({__proto__:null,default:S,get_terminate_flag_offset:P,initThreadPool:x,init_logger:B,run_sparrow:D,wbg_rayon_PoolBuilder:g,wbg_rayon_start_worker:v});let T=!1;self.onmessage=async t=>{const{type:n,payload:e}=t.data,r=e.nWorkers;if(!T)try{if(typeof crossOriginIsolated>"u"||!crossOriginIsolated)throw new Error("Cross-origin isolation not enabled. SharedArrayBuffer is not available. COOP/COEP headers may not be properly set by the service worker. This is common on Android - try refreshing the page.");if(typeof SharedArrayBuffer>"u")throw new Error("SharedArrayBuffer is not available in this browser/context. Multithreading features will not work.");self.postMessage({type:f.PROCESSING,message:"Cross-origin isolation verified. Initializing WASM..."});const o=await S();T=!0;try{await B(5,e.showLogsInstant),self.postMessage({type:f.PROCESSING,message:"Wasm logger successfully initialized"})}catch(_){console.error("Failed to apply WASM logger:",_)}try{await x(r),self.postMessage({type:f.PROCESSING,message:`Wasm thread pool successfully initialized with ${r} threads`})}catch(_){console.error("Failed to initialize WASM thread pool:",_),self.postMessage({type:f.PROCESSING,message:`Failed to initialize WASM thread pool: ${_}`})}const i=o.memory.buffer;if(!(i instanceof SharedArrayBuffer))throw new Error("WASM memory is not a SharedArrayBuffer! Check headers and build flags.");const a=P();self.postMessage({type:f.INIT_SHARED_MEMORY,message:"Worker: Shared memory initialized successfully.",result:{sharedArrayBuffer:i,terminateFlagOffset:a}})}catch(o){self.postMessage({type:f.ERROR,message:"Wasm initialization failed: "+o});return}if(n===f.START){self.postMessage({type:f.PROCESSING,message:"Wasm computation started"});const o=e.input;try{if(e.optimizationAlgo===W.SPARROW){let i;e.timeLimit&&(i=BigInt(e.timeLimit)),D(o,e.showPreviewSvg,i,e.seed,e.useEarlyTermination,e.nWorkers)}}catch(i){self.postMessage({type:f.ERROR,message:"Wasm computation failed: "+i})}}};
