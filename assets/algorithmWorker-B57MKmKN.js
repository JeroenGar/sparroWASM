var f=(t=>(t.IDLE="idle",t.START="start",t.PROCESSING="processing",t.FINISHED="finished",t.ERROR="error",t.CANCEL="cancel",t.INIT_SHARED_MEMORY="init_shared_memory",t.INTERMEDIATE="intermediate",t))(f||{}),I=(t=>(t.SPARROW="sparrow",t))(I||{});function T(t,o){return new Promise(e=>{t.addEventListener("message",function n({data:r}){(r==null?void 0:r.type)===o&&(t.removeEventListener("message",n),e(r))})})}T(self,"wasm_bindgen_worker_init").then(async({init:t,receiver:o})=>{const e=await Promise.resolve().then(function(){return H});await e.default(t),postMessage({type:"wasm_bindgen_worker_ready"}),e.wbg_rayon_start_worker(o)});async function N(t,o,e){if(e.numThreads()===0)throw new Error("num_threads must be > 0.");const n={type:"wasm_bindgen_worker_init",init:{module_or_path:t,memory:o},receiver:e.receiver()};await Promise.all(Array.from({length:e.numThreads()},async()=>{const r=new Worker(new URL("/sparroWASM/assets/workerHelpers-BDb3ppDo.js",import.meta.url),{type:"module"});return r.postMessage(n),await T(r,"wasm_bindgen_worker_ready"),r})),e.build()}function k(){return s.get_terminate_flag_offset()>>>0}function F(t){return s.initThreadPool(t)}function x(t,o){const e=s.init_logger(t,o);if(e[1])throw j(e[0])}function B(t,o,e,n,r,i){const a=s.run_sparrow(t,o,!_(e),_(e)?BigInt(0):e,!_(n),_(n)?BigInt(0):n,r,i);if(a[1])throw j(a[0])}class l{static __wrap(o){o=o>>>0;const e=Object.create(l.prototype);return e.__wbg_ptr=o,W.register(e,e.__wbg_ptr,e),e}__destroy_into_raw(){const o=this.__wbg_ptr;return this.__wbg_ptr=0,W.unregister(this),o}free(){const o=this.__destroy_into_raw();s.__wbg_wbg_rayon_poolbuilder_free(o,0)}build(){s.wbg_rayon_poolbuilder_build(this.__wbg_ptr)}numThreads(){return s.wbg_rayon_poolbuilder_numThreads(this.__wbg_ptr)>>>0}receiver(){return s.wbg_rayon_poolbuilder_receiver(this.__wbg_ptr)>>>0}}Symbol.dispose&&(l.prototype[Symbol.dispose]=l.prototype.free);function z(t){s.wbg_rayon_start_worker(t)}function P(t){return{__proto__:null,"./sparroWASM_bg.js":{__proto__:null,__wbg_Error_8c4e43fe74559d73:function(e,n){return Error(A(e,n))},__wbg_String_8f0eb39a4a4c2f66:function(e,n){const r=String(n),i=M(r,s.__wbindgen_malloc,s.__wbindgen_realloc),a=h;u().setInt32(e+4,a,!0),u().setInt32(e+0,i,!0)},__wbg___wbindgen_boolean_get_bbbb1c18aa2f5e25:function(e){const n=e,r=typeof n=="boolean"?n:void 0;return _(r)?16777215:r?1:0},__wbg___wbindgen_debug_string_0bc8482c6e3508ae:function(e,n){const r=R(n),i=M(r,s.__wbindgen_malloc,s.__wbindgen_realloc),a=h;u().setInt32(e+4,a,!0),u().setInt32(e+0,i,!0)},__wbg___wbindgen_is_undefined_9e4d92534c42d778:function(e){return e===void 0},__wbg___wbindgen_jsval_loose_eq_9dd77d8cd6671811:function(e,n){return e==n},__wbg___wbindgen_memory_bd1fbcf21fbef3c8:function(){return s.memory},__wbg___wbindgen_module_f6b8052d79c1cc16:function(){return L},__wbg___wbindgen_number_get_8ff4255516ccad3e:function(e,n){const r=n,i=typeof r=="number"?r:void 0;u().setFloat64(e+8,_(i)?0:i,!0),u().setInt32(e+0,!_(i),!0)},__wbg___wbindgen_string_get_72fb696202c56729:function(e,n){const r=n,i=typeof r=="string"?r:void 0;var a=_(i)?0:M(i,s.__wbindgen_malloc,s.__wbindgen_realloc),c=h;u().setInt32(e+4,c,!0),u().setInt32(e+0,a,!0)},__wbg___wbindgen_throw_be289d5034ed271b:function(e,n){throw new Error(A(e,n))},__wbg_call_389efe28435a9388:function(){return S(function(e,n){return e.call(n)},arguments)},__wbg_error_9a7fe3f932034cde:function(e){console.error(e)},__wbg_getRandomValues_ea728b1d79dae146:function(){return S(function(e){globalThis.crypto.getRandomValues(e)},arguments)},__wbg_instanceof_ArrayBuffer_c367199e2fa2aa04:function(e){let n;try{n=e instanceof ArrayBuffer}catch{n=!1}return n},__wbg_instanceof_Uint8Array_9b9075935c74707c:function(e){let n;try{n=e instanceof Uint8Array}catch{n=!1}return n},__wbg_instanceof_Window_ed49b2db8df90359:function(e){let n;try{n=e instanceof Window}catch{n=!1}return n},__wbg_length_32ed9a279acd054c:function(e){return e.length},__wbg_new_361308b2356cecd0:function(){return new Object},__wbg_new_3eb36ae241fe6f44:function(){return new Array},__wbg_new_dd2b680c8bf6ae29:function(e){return new Uint8Array(e)},__wbg_new_no_args_1c7c842f08d00ebb:function(e,n){return new Function(A(e,n))},__wbg_new_with_length_a2c39cbe88fd8ff1:function(e){return new Uint8Array(e>>>0)},__wbg_now_2c95c9de01293173:function(e){return e.now()},__wbg_performance_7a3ffd0b17f663ad:function(e){return e.performance},__wbg_postMessage_70ada894b0a6df09:function(e){postMessage(e)},__wbg_prototypesetcall_bdcdcc5842e4d77d:function(e,n,r){Uint8Array.prototype.set.call(U(e,n),r)},__wbg_push_8ffdcb2063340ba5:function(e,n){return e.push(n)},__wbg_set_6cb8631f80447a67:function(){return S(function(e,n,r){return Reflect.set(e,n,r)},arguments)},__wbg_startWorkers_2ca11761e08ff5d5:function(e,n,r){return N(e,n,l.__wrap(r))},__wbg_static_accessor_GLOBAL_12837167ad935116:function(){const e=typeof global>"u"?null:global;return _(e)?0:d(e)},__wbg_static_accessor_GLOBAL_THIS_e628e89ab3b1c95f:function(){const e=typeof globalThis>"u"?null:globalThis;return _(e)?0:d(e)},__wbg_static_accessor_SELF_a621d3dfbb60d0ce:function(){const e=typeof self>"u"?null:self;return _(e)?0:d(e)},__wbg_static_accessor_WINDOW_f8727f0cf888e0bd:function(){const e=typeof window>"u"?null:window;return _(e)?0:d(e)},__wbg_subarray_a96e1fef17ed23cb:function(e,n,r){return e.subarray(n>>>0,r>>>0)},__wbg_timeOrigin_9f29a08704a944d0:function(e){return e.timeOrigin},__wbindgen_cast_0000000000000001:function(e,n){return A(e,n)},__wbindgen_init_externref_table:function(){const e=s.__wbindgen_externrefs,n=e.grow(4);e.set(0,void 0),e.set(n+0,void 0),e.set(n+1,null),e.set(n+2,!0),e.set(n+3,!1)},memory:t||new WebAssembly.Memory({initial:19,maximum:16384,shared:!0})}}}const W=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>s.__wbg_wbg_rayon_poolbuilder_free(t>>>0,1));function d(t){const o=s.__externref_table_alloc();return s.__wbindgen_externrefs.set(o,t),o}function R(t){const o=typeof t;if(o=="number"||o=="boolean"||t==null)return`${t}`;if(o=="string")return`"${t}"`;if(o=="symbol"){const r=t.description;return r==null?"Symbol":`Symbol(${r})`}if(o=="function"){const r=t.name;return typeof r=="string"&&r.length>0?`Function(${r})`:"Function"}if(Array.isArray(t)){const r=t.length;let i="[";r>0&&(i+=R(t[0]));for(let a=1;a<r;a++)i+=", "+R(t[a]);return i+="]",i}const e=/\[object ([^\]]+)\]/.exec(toString.call(t));let n;if(e&&e.length>1)n=e[1];else return toString.call(t);if(n=="Object")try{return"Object("+JSON.stringify(t)+")"}catch{return"Object"}return t instanceof Error?`${t.name}: ${t.message}
${t.stack}`:n}function U(t,o){return t=t>>>0,y().subarray(t/1,t/1+o)}let g=null;function u(){return(g===null||g.buffer!==s.memory.buffer)&&(g=new DataView(s.memory.buffer)),g}function A(t,o){return t=t>>>0,$(t,o)}let w=null;function y(){return(w===null||w.buffer!==s.memory.buffer)&&(w=new Uint8Array(s.memory.buffer)),w}function S(t,o){try{return t.apply(this,o)}catch(e){const n=d(e);s.__wbindgen_exn_store(n)}}function _(t){return t==null}function M(t,o,e){if(e===void 0){const c=m.encode(t),b=o(c.length,1)>>>0;return y().subarray(b,b+c.length).set(c),h=c.length,b}let n=t.length,r=o(n,1)>>>0;const i=y();let a=0;for(;a<n;a++){const c=t.charCodeAt(a);if(c>127)break;i[r+a]=c}if(a!==n){a!==0&&(t=t.slice(a)),r=e(r,n,n=a+t.length*3,1)>>>0;const c=y().subarray(r+a,r+n),b=m.encodeInto(t,c);a+=b.written,r=e(r,n,a,1)>>>0}return h=a,r}function j(t){const o=s.__wbindgen_externrefs.get(t);return s.__externref_table_dealloc(t),o}let p=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):void 0;p&&p.decode();const v=2146435072;let E=0;function $(t,o){return E+=o,E>=v&&(p=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),p.decode(),E=o),p.decode(y().slice(t,t+o))}const m=typeof TextEncoder<"u"?new TextEncoder:void 0;m&&(m.encodeInto=function(t,o){const e=m.encode(t);return o.set(e),{read:t.length,written:e.length}});let h=0,L,s;function D(t,o,e){if(s=t.exports,L=o,g=null,w=null,typeof e<"u"&&(typeof e!="number"||e===0||e%65536!==0))throw"invalid stack size";return s.__wbindgen_start(e),s}async function G(t,o){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,o)}catch(r){if(t.ok&&e(t.type)&&t.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,o)}else{const n=await WebAssembly.instantiate(t,o);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}function e(n){switch(n){case"basic":case"cors":case"default":return!0}return!1}}function V(t,o){if(s!==void 0)return s;let e;t!==void 0&&(Object.getPrototypeOf(t)===Object.prototype?{module:t,memory:o,thread_stack_size:e}=t:console.warn("using deprecated parameters for `initSync()`; pass a single object instead"));const n=P(o);t instanceof WebAssembly.Module||(t=new WebAssembly.Module(t));const r=new WebAssembly.Instance(t,n);return D(r,t,e)}async function C(t,o){if(s!==void 0)return s;let e;t!==void 0&&(Object.getPrototypeOf(t)===Object.prototype?{module_or_path:t,memory:o,thread_stack_size:e}=t:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),t===void 0&&(t=new URL("/sparroWASM/assets/sparroWASM_bg-crWgBS9U.wasm",import.meta.url));const n=P(o);(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:r,module:i}=await G(await t,n);return D(r,i,e)}var H=Object.freeze({__proto__:null,default:C,get_terminate_flag_offset:k,initSync:V,initThreadPool:F,init_logger:x,run_sparrow:B,wbg_rayon_PoolBuilder:l,wbg_rayon_start_worker:z});let O=!1;self.onmessage=async t=>{const{type:o,payload:e}=t.data,n=e.nWorkers;if(!O)try{if(typeof crossOriginIsolated>"u"||!crossOriginIsolated)throw new Error("Cross-origin isolation not enabled. SharedArrayBuffer is not available. COOP/COEP headers may not be properly set by the service worker. This is common on Android - try refreshing the page.");if(typeof SharedArrayBuffer>"u")throw new Error("SharedArrayBuffer is not available in this browser/context. Multithreading features will not work.");self.postMessage({type:f.PROCESSING,message:"Cross-origin isolation verified. Initializing WASM..."});const r=await C();O=!0;try{await x(5,e.showLogsInstant),self.postMessage({type:f.PROCESSING,message:"Wasm logger successfully initialized"})}catch(c){console.error("Failed to apply WASM logger:",c)}try{await F(n),self.postMessage({type:f.PROCESSING,message:`Wasm thread pool successfully initialized with ${n} threads`})}catch(c){console.error("Failed to initialize WASM thread pool:",c),self.postMessage({type:f.PROCESSING,message:`Failed to initialize WASM thread pool: ${c}`})}const i=r.memory.buffer;if(!(i instanceof SharedArrayBuffer))throw new Error("WASM memory is not a SharedArrayBuffer! Check headers and build flags.");const a=k();self.postMessage({type:f.INIT_SHARED_MEMORY,message:"Worker: Shared memory initialized successfully.",result:{sharedArrayBuffer:i,terminateFlagOffset:a}})}catch(r){self.postMessage({type:f.ERROR,message:"Wasm initialization failed: "+r});return}if(o===f.START){self.postMessage({type:f.PROCESSING,message:"Wasm computation started"});const r=e.input;try{if(e.optimizationAlgo===I.SPARROW){let i;e.timeLimit&&(i=BigInt(e.timeLimit)),B(r,e.showPreviewSvg,i,e.seed,e.useEarlyTermination,e.nWorkers)}}catch(i){self.postMessage({type:f.ERROR,message:"Wasm computation failed: "+i})}}};
